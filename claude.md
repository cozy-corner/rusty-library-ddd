# Claude Code 開発ガイド

このドキュメントは、Claude Codeを使ってこのプロジェクトを開発する際の方針を記載します。

## 開発方針

### TDD（テスト駆動開発）を採用

このプロジェクトでは、適切な箇所でTDDを採用します。

#### ドメイン層：TDDで実装

ドメイン層は純粋関数で構成されており、TDDに最適です。

**理由：**
- 副作用なし
- データベース不要
- 外部依存なし
- 入力→出力が明確
- テストが即座に実行できる

**TDDサイクル：**
1. **Red**: ビジネスルールに基づいてテストを書く（失敗する）
2. **Green**: テストを通す最小限の実装
3. **Refactor**: コードをリファクタリング

**対象：**
- 値オブジェクト
- 集約
- 純粋関数
- fold/reduceによる状態復元

### 開発サイクル（必須）

**すべての変更において、以下を必ず実施：**

1. **Format**: `cargo fmt` - コードフォーマット
2. **Lint**: `cargo clippy` - 静的解析
3. **Test**: `cargo test` - テスト実行

**実施タイミング：**
- ファイルを変更するたび
- コミット前
- Pull Request作成前

**目的：**
- コード品質の維持
- 一貫性のあるコードスタイル
- 早期のバグ検出

#### その他の層：実装後にテストを書く

**ポート定義：**
- trait定義のみなので、テスト不要

**アダプター層：**
- モック実装：シンプルなのでテスト不要
- 実装（PostgreSQL、HTTP等）：統合テストを実装後に作成

**アプリケーション層：**
- 実装後にモックを使った統合テストを作成

**API層：**
- 実装後にHTTPリクエストのテストを作成

## テスト戦略

### ドメイン層のテスト

**テストすべきこと：**
- ビジネスルールの正常系
- ビジネスルール違反のエラー
- 境界値テスト
- 状態復元（fold/reduce）の正確性

**特徴：**
- 純粋関数なので単体テストが容易
- データベース不要
- 高速実行

### アプリケーション層のテスト

**テストすべきこと：**
- ユースケースの正常系
- 外部サービスのエラーハンドリング
- イベント保存とRead Model更新の連携

**実装方針：**
- モックを使った統合テスト

### API層のテスト

**テストすべきこと：**
- HTTPリクエストの処理
- レスポンス形式
- エラーレスポンス

## 実装の原則

### 関数型DDDの原則

- **純粋関数**: ドメイン層は副作用なし
- **イミュータビリティ**: すべてのデータは不変
- **決定と実行の分離**: ドメイン層は決定、アプリケーション層は実行
- **型でビジネスルールを表現**: 不正な状態を型システムで排除

### アーキテクチャの原則

- **ヘキサゴナルアーキテクチャ**: ポート&アダプター
- **依存の方向**: 外側が内側に依存、ドメイン層は何にも依存しない
- **コンテキスト境界**: 他の集約はIDで参照、ポート経由で依存

詳細は各ドキュメント（`doc/`）を参照してください。
