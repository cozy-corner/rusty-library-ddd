# Phase 1: タスクリスト

Phase 1（貸出管理コンテキスト）の実装タスク一覧。

各タスクは1つのPRに対応します。

## 進め方

```bash
# タスクブランチ作成
just task-start phase1 <task-name>

# 実装（TDDの場合）
# - Red: テストを書く
# - Green: 実装する
# - Refactor: リファクタリング

# チェック
just task-check

# コミット
git add .
git commit -m "<type>: <description>"

# プッシュ & PR作成
just task-push
just task-pr "<PR title>"

# マージ後
just task-done
```

---

## Task 1: ドメイン層

**ブランチ:** `feature/phase1/domain-layer`

**スコープ:** ドメイン層のすべて（純粋関数、ビジネスロジック）

**実装内容:**

1. 値オブジェクトを定義
   - LoanId, BookId, MemberId, StaffId
   - ExtensionCount（ビジネスルール「延長は1回まで」を型で強制）
   - LoanStatus（Active, Overdue, Returned）

2. Loan集約を定義
   - Loan struct
   - Loan::empty()

3. 純粋関数を実装（TDD）
   - loan_book()
   - extend_loan()
   - return_book()

4. コマンド、イベントを定義
   - コマンド: LoanBook, ExtendLoan, ReturnBook
   - イベント: BookLoaned, LoanExtended, BookReturned, LoanBecameOverdue
   - DomainEvent enum

5. fold/reduceによる状態復元を実装
   - apply_event()
   - replay_events()

**ファイル:**
- `src/domain/value_objects.rs`
- `src/domain/loan.rs`
- `src/domain/commands.rs`
- `src/domain/events.rs`
- `src/domain/errors.rs`
- `src/domain/mod.rs`

**確認ポイント:**
- すべて純粋関数か
- イミュータブルか
- 型でビジネスルールを表現しているか
- TDDで実装したか

---

## Task 2: ポート定義

**ブランチ:** `feature/phase1/ports`

**スコープ:** ポート（trait）定義のみ

**実装内容:**

- EventStore trait
- LoanReadModel trait
- MemberService trait
- BookService trait
- NotificationService trait

**ファイル:**
- `src/ports/event_store.rs`
- `src/ports/loan_read_model.rs`
- `src/ports/member_service.rs`
- `src/ports/book_service.rs`
- `src/ports/notification_service.rs`
- `src/ports/mod.rs`

**確認ポイント:**
- 必要最小限のインターフェースか
- 利用側の視点で定義されているか
- 実装方法に依存していないか

**依存:** Task 1

---

## Task 3: アダプター（モック実装）

**ブランチ:** `feature/phase1/mock-adapters`

**スコープ:** モック実装のみ

**実装内容:**

- MemberService のモック実装
- BookService のモック実装
- NotificationService のモック実装

**ファイル:**
- `src/adapters/mock/member_service.rs`
- `src/adapters/mock/book_service.rs`
- `src/adapters/mock/notification_service.rs`
- `src/adapters/mock/mod.rs`
- `src/adapters/mod.rs`

**実装方針:**
- 固定値を返す
- データを保存しない

**依存:** Task 2

---

## Task 4: アダプター（PostgreSQL）

**ブランチ:** `feature/phase1/postgres-adapters`

**スコープ:** PostgreSQL関連のすべて

**実装内容:**

1. データベースマイグレーション
   - events テーブル
   - loans_view テーブル
   - インデックス

2. EventStore の実装
   - append()
   - load()

3. LoanReadModel の実装
   - insert(), update(), find() 等

4. プロジェクター（イベント → Read Model更新）

**ファイル:**
- `migrations/001_create_events.sql`
- `migrations/002_create_loans_view.sql`
- `src/adapters/postgres/event_store.rs`
- `src/adapters/postgres/loan_read_model.rs`
- `src/adapters/postgres/projector.rs`
- `src/adapters/postgres/mod.rs`
- `Cargo.toml`（sqlx追加）

**確認ポイント:**
- トランザクション管理
- JSONBでのシリアライゼーション
- 統合テスト

**依存:** Task 2

---

## Task 5: アプリケーション層

**ブランチ:** `feature/phase1/application-layer`

**スコープ:** アプリケーション層のすべて

**実装内容:**

1. LoanService の実装
   - execute_loan_book()
   - execute_extend_loan()
   - execute_return_book()

2. 延滞検出バッチの実装
   - detect_overdue_loans()

**ファイル:**
- `src/application/loan_service.rs`
- `src/application/overdue_detection.rs`
- `src/application/mod.rs`

**確認ポイント:**
- 副作用の実行
- ドメイン層の純粋関数を呼ぶ
- エラーハンドリング
- モックを使った統合テスト

**依存:** Task 2, 3

---

## Task 6: API層

**ブランチ:** `feature/phase1/api-layer`

**スコープ:** API層のすべて

**実装内容:**

1. リクエスト/レスポンス型の定義
   - LoanBookRequest, ExtendLoanRequest, ReturnBookRequest
   - LoanResponse, ErrorResponse
   - バリデーション

2. ハンドラーの実装
   - POST /loans（貸出作成）
   - POST /loans/:id/extend（延長）
   - POST /loans/:id/return（返却）
   - GET /loans（一覧取得）
   - GET /loans/:id（詳細取得）
   - エラーハンドリング

**ファイル:**
- `src/api/types.rs`
- `src/api/handlers.rs`
- `src/api/mod.rs`
- `Cargo.toml`（axum, serde等追加）

**確認ポイント:**
- HTTPステータスコード
- エラーレスポンス

**依存:** Task 5

---

## Task 7: 統合

**ブランチ:** `feature/phase1/integration`

**スコープ:** 統合とE2Eテスト

**実装内容:**

1. main.rs の実装
   - 依存性注入の設定
   - ルーター設定
   - データベース接続
   - 環境変数読み込み

2. E2Eテスト
   - 貸出→延長→返却のフロー
   - エラーケースのテスト

3. 動作確認

**ファイル:**
- `src/main.rs`
- `tests/e2e_test.rs`
- `.env`（ローカル用）

**確認ポイント:**
- すべてのコンポーネントが統合される
- アプリケーションが起動する
- APIが動作する
- 全体フローが動作する

**依存:** Task 4, 5, 6

---

## 進捗管理

- [ ] Task 1: ドメイン層
- [ ] Task 2: ポート定義
- [ ] Task 3: アダプター（モック）
- [ ] Task 4: アダプター（PostgreSQL）
- [ ] Task 5: アプリケーション層
- [ ] Task 6: API層
- [ ] Task 7: 統合
