# Claude Code 開発ガイド

このドキュメントは、Claude Codeを使ってこのプロジェクトを開発する際の方針を記載します。

## 開発方針

### TDD（テスト駆動開発）を採用

このプロジェクトでは、適切な箇所でTDDを採用します。

#### ドメイン層：TDDで実装

ドメイン層は純粋関数で構成されており、TDDに最適です。

**理由：**
- 副作用なし
- データベース不要
- 外部依存なし
- 入力→出力が明確
- テストが即座に実行できる

**TDDサイクル：**
1. **Red**: ビジネスルールに基づいてテストを書く（失敗する）
2. **Green**: テストを通す最小限の実装
3. **Refactor**: コードをリファクタリング

**対象：**
- 値オブジェクト
- 集約
- 純粋関数
- fold/reduceによる状態復元

#### その他の層：実装後にテストを書く

**ポート定義：**
- trait定義のみなので、テスト不要

**アダプター層：**
- モック実装：シンプルなのでテスト不要
- 実装（PostgreSQL、HTTP等）：統合テストを実装後に作成

**アプリケーション層：**
- 実装後にモックを使った統合テストを作成

**API層：**
- 実装後にHTTPリクエストのテストを作成

## テスト戦略

### ドメイン層のテスト

**テストすべきこと：**
- ビジネスルールの正常系
- ビジネスルール違反のエラー
- 境界値テスト
- 状態復元（fold/reduce）の正確性

**特徴：**
- 純粋関数なので単体テストが容易
- データベース不要
- 高速実行

### アプリケーション層のテスト

**テストすべきこと：**
- ユースケースの正常系
- 外部サービスのエラーハンドリング
- イベント保存とRead Model更新の連携

**実装方針：**
- モックを使った統合テスト

### API層のテスト

**テストすべきこと：**
- HTTPリクエストの処理
- レスポンス形式
- エラーレスポンス

## 実装の原則

### 関数型DDDの原則

- **純粋関数**: ドメイン層は副作用なし
- **イミュータビリティ**: すべてのデータは不変
- **決定と実行の分離**: ドメイン層は決定、アプリケーション層は実行
- **型でビジネスルールを表現**: 不正な状態を型システムで排除

### アーキテクチャの原則

- **ヘキサゴナルアーキテクチャ**: ポート&アダプター
- **依存の方向**: 外側が内側に依存、ドメイン層は何にも依存しない
- **コンテキスト境界**: 他の集約はIDで参照、ポート経由で依存

### コメントの原則

- **本質的な情報のみ記載**: コードの目的、意図、ビジネスルールを説明する
- **避けるべき情報**:
  - タスク番号（Task 1.1a等）
  - 日付
  - 作業者名
  - その他、時間経過で陳腐化する情報
- **理由**: コメントはコードの「なぜ」を説明するものであり、プロジェクト管理情報はGit履歴やドキュメントで管理する

詳細は各ドキュメント（`doc/`）を参照してください。

## ブランチ戦略

### GitHub Flow

シンプルなGitHub Flowを採用します。

**ブランチ構成:**
- `main` ブランチのみ
- mainは常に動作する状態を保つ

**ブランチ命名規則:**
```
feature/<phase>/<task-name>
```

例:
- `feature/phase1/value-objects`
- `feature/phase1/loan-aggregate`
- `feature/phase2/reservation-aggregate`

**ワークフロー:**
1. mainからタスクブランチを作成
2. 実装・テスト・コミット
3. PRを作成してmainにマージ
4. ブランチ削除

## タスク分割

### タスク単位 = PR単位

各タスクは1つのPRに対応します。

**タスク分割の原則:**
- 1タスク = 1つの明確な責務
- レビュー可能なサイズ（数百行程度）
- 単独でテスト・動作確認可能
- 他のタスクと独立

**Phase単位でのタスク管理:**
- 各Phaseの実装計画から、PR単位のタスクに分割
- タスクリストは `doc/phase/tasks/<phase番号>.md` に記載
- 依存関係を明記

## 開発サイクル

### タスクの進め方

```bash
# 1. タスクブランチ作成
just task-start phase1 <task-name>

# 2. 実装（TDDの場合）
# - Red: テストを書く（失敗する）
# - Green: 実装する（テストが通る）
# - Refactor: リファクタリング

# 3. チェック（format, lint, test）
just task-check

# 4. コミット（pre-commit hookが自動実行される）
git add .
git commit -m "<type>: <description>"

# 5. リモートへプッシュ
just task-push

# 6. PR作成
just task-pr "<PR title>"
# または GitHub上で手動作成

# 7. レビュー・マージ後、ブランチ削除
just task-done
```

### コミットメッセージ規則

Conventional Commitsに従います：

```
<type>: <description>

[optional body]
```

**主なtype:**
- `feat`: 新機能
- `fix`: バグ修正
- `refactor`: リファクタリング
- `test`: テスト追加・修正
- `docs`: ドキュメント
- `chore`: ビルド、ツール設定等

**例:**
```
feat: implement ExtensionCount value object

- Add ExtensionCount with business rule (max 1 extension)
- Add increment() with validation
- Add TDD tests
```

## 環境要件

### 必須環境

- **Rust**: edition 2024
- **PostgreSQL**: 17

### 主要な依存ライブラリ

- **Webフレームワーク**: Axum
- **非同期ランタイム**: Tokio
- **データベースアクセス**: sqlx
- **シリアライゼーション**: serde
- **日時処理**: chrono
- **ID生成**: uuid

### 開発ツール

- **品質管理**: cargo-husky（pre-commit hook）
  - Format check: `cargo fmt`
  - Lint: `cargo clippy`
  - Test: `cargo test`

詳細なバージョンは `Cargo.toml` を参照してください。
